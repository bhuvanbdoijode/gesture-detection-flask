<!DOCTYPE html>
<html>
<head>
    <title>Gesture Detection (Browser)</title>
    <style>
        body { text-align: center; background: #111; color: white; font-family: Arial; }
        video, canvas { border: 2px solid white; border-radius: 10px; margin-top: 20px; }
    </style>

    <!-- MediaPipe JS -->
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils"></script>
</head>

<body>
    <h1>Gesture Detection (Client-Side)</h1>

    <video id="video" width="640" height="480" autoplay playsinline></video>
    <canvas id="output" width="640" height="480"></canvas>

    <h2 id="gesture">Gesture: Detecting...</h2>

    <script>
        const videoElement = document.getElementById('video');
        const canvasElement = document.getElementById('output');
        const canvasCtx = canvasElement.getContext('2d');

        // Start camera
        async function startCamera() {
            const stream = await navigator.mediaDevices.getUserMedia({ video: true });
            videoElement.srcObject = stream;
        }
        startCamera();

        // MediaPipe Hands
        const hands = new Hands({
            locateFile: file => `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}`
        });

        hands.setOptions({
            maxNumHands: 1,
            modelComplexity: 1,
            minDetectionConfidence: 0.7,
            minTrackingConfidence: 0.7
        });

        hands.onResults(results => {
            canvasCtx.save();
            canvasCtx.clearRect(0, 0, canvasElement.width, canvasElement.height);
            canvasCtx.drawImage(results.image, 0, 0, canvasElement.width, canvasElement.height);

            if (results.multiHandLandmarks && results.multiHandLandmarks.length > 0) {
                for (const landmarks of results.multiHandLandmarks) {
                    drawConnectors(canvasCtx, landmarks, HAND_CONNECTIONS);
                    drawLandmarks(canvasCtx, landmarks);
                    detectGesture(landmarks);
                }
            }
            canvasCtx.restore();
        });

        const camera = new Camera(videoElement, {
            onFrame: async () => { await hands.send({ image: videoElement }); },
            width: 640,
            height: 480
        });
        camera.start();

        let lastGesture = "";
let gestureHoldFrames = 0;
const HOLD_THRESHOLD = 5; // gesture must stay stable for 5 frames

function detectGesture(landmarks) {

    function fingerIsUp(tip, pip, mcp) {
        // Check vertical direction + bone angles â†’ more accurate
        return (
            landmarks[tip].y < landmarks[pip].y &&
            landmarks[pip].y < landmarks[mcp].y
        );
    }

    function distance(a, b) {
        return Math.hypot(a.x - b.x, a.y - b.y);
    }

    const thumbUp = landmarks[4].y < landmarks[3].y;
    const indexUp = fingerIsUp(8, 6, 5);
    const middleUp = fingerIsUp(12, 10, 9);
    const ringUp = fingerIsUp(16, 14, 13);
    const pinkyUp = fingerIsUp(20, 18, 17);

    // Detect fist using distances (accurate even when tilted)
    const palmSize = distance(landmarks[0], landmarks[9]);
    const fistClosed =
        distance(landmarks[8], landmarks[5]) < palmSize * 0.3 &&
        distance(landmarks[12], landmarks[9]) < palmSize * 0.3 &&
        distance(landmarks[16], landmarks[13]) < palmSize * 0.3 &&
        distance(landmarks[20], landmarks[17]) < palmSize * 0.3;

    let detected = "Detecting...";

    // âœŠ FIST
    if (fistClosed) {
        detected = "âœŠ Fist";
    }
    // ðŸ–ï¸ Open Palm
    else if (thumbUp && indexUp && middleUp && ringUp && pinkyUp) {
        detected = "ðŸ–ï¸ Open Palm";
    }
    // ðŸ‘ Thumbs Up
    else if (thumbUp && !indexUp && !middleUp && !ringUp && !pinkyUp) {
        detected = "ðŸ‘ Thumbs Up";
    }
    // âœŒï¸ Victory
    else if (indexUp && middleUp && !ringUp && !pinkyUp) {
        detected = "âœŒï¸ Victory";
    }
    // ðŸ‘‰ Pointing
    else if (indexUp && !middleUp && !ringUp && !pinkyUp) {
        detected = "ðŸ‘‰ Pointing";
    }

    // -------- STABILIZATION (IMPORTANT) --------
    if (detected === lastGesture) {
        gestureHoldFrames++;
    } else {
        gestureHoldFrames = 0;
    }
    lastGesture = detected;

    if (gestureHoldFrames >= HOLD_THRESHOLD) {
        document.getElementById("gesture").innerText = "Gesture: " + detected;
    }
}

    </script>
</body>
</html>
